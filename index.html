
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKB48 终极养成模拟器 v9.0 - 运营委员会版</title>
    <!-- 依赖库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #fff5f7; margin: 0; }
        .pink-gradient { background: linear-gradient(135deg, #ff4d94 0%, #ff7eb3 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide { animation: slideIn 0.5s ease-out forwards; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.41.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.574.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 核心常量 ---
        const TEAMS = ['Team A', 'Team K', 'Team B', 'Team 4'];
        const SISTER_GROUPS = ['SKE48', 'NMB48', 'HKT48', 'NGT48', 'STU48', 'JKT48'];
        const REAL_MEMBERS = ["柏木由纪", "向井地美音", "小栗有以", "冈田奈奈", "本田仁美", "渡边麻友", "前田敦子", "大岛优子", "指原莉乃", "宫胁咲良"];

        const INITIAL_STATS = {
            visual: 50, performance: 40, variety: 35, popularity: 150,
            stamina: 100, mood: 100, love: 20, exposure: 50
        };

        // --- Gemini 服务 ---
        async function fetchNarrative(state, eventType) {
            try {
                // 如果没有 API KEY，返回本地默认剧情
                if (!window.process?.env?.API_KEY) {
                    return { title: eventType, description: `这是关于 ${eventType} 的一段模拟剧情...` };
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${window.process.env.API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `你现在是 AKB48 运营委员会。当前是第 ${state.time.year} 年第 ${state.time.quarter} 季度。成员${state.player.name}正在经历：${eventType}。请生成一段 200 字以内的热血偶像剧风格描述。返回 JSON: { "title": "...", "description": "..." }` }] }]
                    })
                });
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                return { title: eventType, description: "由于网络波动，运营的公告正在路上..." };
            }
        }

        // --- 主程序 ---
        function App() {
            const [state, setState] = useState({
                player: {
                    name: "主控成员", team: "Team A", stats: { ...INITIAL_STATS },
                    currentRank: "圈外", centerCount: 0, isKenmin: false,
                    currentSingleStatus: 'None', // None, Senbatsu, Center
                },
                members: REAL_MEMBERS.slice(0, 5).map(n => ({ name: n, bond: 20, isCP: false })),
                time: { year: 1, quarter: 1 },
                actionsRemaining: 3,
                logs: [],
                gameStatus: 'start', // start, playing, ended
                jankenWon: false,
            });

            const [overlay, setOverlay] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            const addLog = (tag, message, color = 'text-pink-600') => {
                const log = { id: Date.now(), tag, message, color };
                setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 50) }));
            };

            const startGame = () => {
                setState(prev => ({ ...prev, gameStatus: 'playing' }));
                addLog("系统", "入团大典结束，你的偶像生涯正式开始！");
            };

            // 训练与行动
            const doAction = (type) => {
                if (state.actionsRemaining <= 0) return;
                setState(prev => {
                    const p = { ...prev.player };
                    const cost = p.isKenmin ? 30 : 20;
                    if (p.stats.stamina < cost && type !== 'rest') {
                        alert("体力不足！"); return prev;
                    }

                    switch(type) {
                        case 'lesson': p.stats.performance += 8; p.stats.stamina -= cost; break;
                        case 'variety': p.stats.variety += 8; p.stats.love += 5; p.stats.stamina -= cost; break;
                        case 'work': p.stats.popularity += 200; p.stats.exposure += 10; p.stats.stamina -= cost; break;
                        case 'rest': p.stats.stamina = Math.min(100, p.stats.stamina + 60); break;
                        case 'bond': 
                            const m = [...prev.members];
                            const idx = Math.floor(Math.random() * m.length);
                            m[idx].bond += 15;
                            if (m[idx].bond >= 80 && !m[idx].isCP) {
                                m[idx].isCP = true;
                                addLog("CP", `你与 ${m[idx].name} 组成了官方CP！人气稳定上升。`);
                            }
                            return { ...prev, player: p, members: m, actionsRemaining: prev.actionsRemaining - 1 };
                    }
                    return { ...prev, player: p, actionsRemaining: prev.actionsRemaining - 1 };
                });
                addLog("行动", "完成了一项日常工作。");
            };

            // 推进季度
            const nextQuarter = async () => {
                setIsLoading(true);
                const { year, quarter } = state.time;
                const p = state.player;
                
                let summary = "";
                let eventType = "季度结算";

                // --- 逻辑分支 ---
                if (quarter === 1) { // 樱花单
                    const score = (p.stats.popularity/100)*0.3 + p.stats.love*0.5 + p.stats.performance*0.2;
                    let status = 'None';
                    if (score > 70) { status = 'Center'; p.centerCount++; summary = "恭喜！你成为了樱花单Center！"; }
                    else if (score > 50) { status = 'Senbatsu'; summary = "你进入了樱花单选拔组！"; }
                    else summary = "很遗憾，你落选了樱花单选拔。";
                    p.currentSingleStatus = status;
                    eventType = "樱花单选拔发表";
                } 
                else if (quarter === 2) { // 夏日单 + 总选投票
                    const score = (p.stats.popularity/100)*0.5 + p.stats.love*0.3 + p.stats.performance*0.2;
                    let status = 'None';
                    if (score > 70) { status = 'Center'; p.centerCount++; summary = "阳光、沙滩、你！你是夏日单Center！"; }
                    else if (score > 50) { status = 'Senbatsu'; summary = "入选夏日选拔，去海边拍摄吧！"; }
                    p.currentSingleStatus = status;
                    eventType = "夏日单发表与总选投票开始";
                }
                else if (quarter === 3) { // 总选结果 + 猜拳
                    // 总选排名判定
                    const pop = p.stats.popularity;
                    if (pop > 10000) p.currentRank = "Center";
                    else if (pop > 7000) p.currentRank = "神七";
                    else if (pop > 4000) p.currentRank = "选拔组";
                    else if (pop > 1000) p.currentRank = "圈内";
                    else p.currentRank = "圈外";
                    
                    summary = `总选开票！你的最终顺位是：${p.currentRank}。`;
                    
                    // 猜拳大会 (每两年)
                    if (year % 2 === 0) {
                        const win = Math.random() > 0.8; // 20%胜率
                        setState(prev => ({ ...prev, jankenWon: win }));
                        if (win) summary += " 并且...你赢得了猜拳大会优胜！！";
                    }
                    eventType = "总选举开票与猜拳大会";
                }
                else if (quarter === 4) { // 猜拳单 + RH100 + 组阁 + 红白
                    eventType = "年度盛典与组阁祭";
                    
                    // 猜拳单效果
                    if (state.jankenWon) {
                        const effectScore = p.stats.visual * 0.4 + p.stats.performance * 0.4 + (p.stats.popularity/100) * 0.2;
                        p.centerCount++;
                        if (effectScore > 60) {
                            p.stats.popularity += 3000;
                            summary = "猜拳单大获成功，你的强运和实力震惊了业界！";
                        } else {
                            p.stats.popularity -= 500;
                            p.stats.love -= 10;
                            summary = "虽然是猜拳Center，但因为表现力不足受到了不少非议。";
                        }
                    }

                    // RH100
                    if (p.stats.popularity > 2000) {
                        p.stats.popularity += 800;
                        addLog("RH100", "你的曲目进入了前100，增加了大量粉丝！");
                    }

                    // 组阁祭
                    if (Math.random() > 0.7) {
                        if (p.stats.performance > 80 && p.stats.love > 70 && !p.isKenmin) {
                            p.isKenmin = true;
                            addLog("组阁", "你被委任为兼任成员，工作强度增加，但机会更多了！", "text-purple-600");
                        } else if (p.stats.love < 20 || Math.random() > 0.9) {
                            const sister = SISTER_GROUPS[Math.floor(Math.random() * SISTER_GROUPS.length)];
                            p.team = sister;
                            addLog("组阁", `震撼移籍！你被移动到了 ${sister}。`, "text-red-600");
                        }
                    }

                    // 红白
                    if (p.stats.popularity > 6000 || (p.currentRank === 'Center' || p.currentRank === '神七')) {
                        p.stats.popularity += 1500;
                        addLog("红白", "入选红白歌合战！全日本都记住了你的名字。");
                    }
                }

                const narrative = await fetchNarrative(state, eventType);
                setOverlay({ title: narrative.title, description: (summary ? summary + "\n\n" : "") + narrative.description });

                setState(prev => {
                    let nextQ = prev.time.quarter + 1;
                    let nextY = prev.time.year;
                    if (nextQ > 4) { nextQ = 1; nextY++; }
                    return {
                        ...prev,
                        time: { year: nextY, quarter: nextQ },
                        player: p,
                        actionsRemaining: 3,
                        jankenWon: nextQ === 4 ? prev.jankenWon : false, // 只有Q4会消耗猜拳胜场
                        gameStatus: nextY > 10 ? 'ended' : 'playing'
                    };
                });
                setIsLoading(false);
            };

            // UI 组件
            const StatItem = ({ label, value, max=100, icon }) => (
                <div className="bg-white p-3 rounded-2xl shadow-sm border border-pink-100">
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-xs font-bold text-gray-500 flex items-center gap-1">{icon} {label}</span>
                        <span className="text-sm font-black text-pink-600">{Math.floor(value)}</span>
                    </div>
                    <div className="w-full h-1.5 bg-pink-50 rounded-full overflow-hidden">
                        <div className="h-full bg-pink-500 transition-all duration-500" style={{ width: `${Math.min(100, (value/max)*100)}%` }}></div>
                    </div>
                </div>
            );

            if (state.gameStatus === 'start') return (
                <div className="h-screen pink-gradient flex flex-col items-center justify-center text-white text-center p-6">
                    <h1 className="text-6xl font-black mb-2 drop-shadow-lg">AKB48模拟器</h1>
                    <p className="text-xl mb-12 opacity-90 italic">ULTIMATE IDOL LIFE v9.0</p>
                    <button onClick={startGame} className="bg-white text-pink-600 px-16 py-5 rounded-full text-2xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-all">
                        开始梦想之旅
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen max-w-6xl mx-auto flex flex-col bg-white overflow-hidden shadow-2xl">
                    {/* 遮罩层 */}
                    {overlay && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 backdrop-blur-md">
                            <div className="bg-white rounded-3xl p-8 max-w-2xl w-full animate-slide border-4 border-pink-400">
                                <h2 className="text-3xl font-black text-pink-600 mb-4">{overlay.title}</h2>
                                <p className="text-gray-700 text-lg leading-relaxed mb-8 whitespace-pre-wrap">{overlay.description}</p>
                                <button onClick={() => setOverlay(null)} className="w-full bg-pink-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg">确认</button>
                            </div>
                        </div>
                    )}

                    {/* 头部 */}
                    <header className="pink-gradient p-6 text-white flex justify-between items-center">
                        <div>
                            <div className="text-sm font-bold opacity-80 uppercase tracking-widest">第 {state.time.year} 年 / Q{state.time.quarter}</div>
                            <h2 className="text-3xl font-black">{state.player.team} · {state.player.name}</h2>
                        </div>
                        <div className="flex gap-4">
                            <div className="bg-white/20 p-3 rounded-2xl text-center min-w-[80px]">
                                <div className="text-[10px] font-bold opacity-70">顺位</div>
                                <div className="font-black text-xl">{state.player.currentRank}</div>
                            </div>
                            <div className="bg-white/20 p-3 rounded-2xl text-center min-w-[80px]">
                                <div className="text-[10px] font-bold opacity-70">C位次数</div>
                                <div className="font-black text-xl">{state.player.centerCount}</div>
                            </div>
                        </div>
                    </header>

                    {/* 属性栏 */}
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 p-4 bg-pink-50 border-b">
                        <StatItem label="颜值" value={state.player.stats.visual} icon={<i data-lucide="eye" className="w-3 h-3"></i>} />
                        <StatItem label="表现" value={state.player.stats.performance} icon={<i data-lucide="mic" className="w-3 h-3"></i>} />
                        <StatItem label="综艺" value={state.player.stats.variety} icon={<i data-lucide="tv" className="w-3 h-3"></i>} />
                        <StatItem label="人气" value={state.player.stats.popularity} max={15000} icon={<i data-lucide="users" className="w-3 h-3"></i>} />
                        <StatItem label="体力" value={state.player.stats.stamina} icon={<i data-lucide="battery" className="w-3 h-3"></i>} />
                        <StatItem label="心情" value={state.player.stats.mood} icon={<i data-lucide="smile" className="w-3 h-3"></i>} />
                        <StatItem label="运营爱" value={state.player.stats.love} icon={<i data-lucide="heart" className="w-3 h-3"></i>} />
                        <StatItem label="曝光" value={state.player.stats.exposure} icon={<i data-lucide="sun" className="w-3 h-3"></i>} />
                    </div>

                    {/* 主内容 */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* 左：伙伴 */}
                        <div className="w-64 bg-gray-50 p-4 border-r overflow-y-auto hidden lg:block">
                            <h3 className="font-black text-gray-400 text-xs uppercase mb-4 tracking-widest">核心成员关系</h3>
                            {state.members.map(m => (
                                <div key={m.name} className="mb-3 p-3 bg-white rounded-xl shadow-sm border border-gray-100">
                                    <div className="flex justify-between font-bold text-sm mb-1">
                                        {m.name} {m.isCP && <span className="text-red-500">❤️ CP</span>}
                                        <span className="text-pink-400">{m.bond}</span>
                                    </div>
                                    <div className="w-full h-1 bg-gray-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-pink-300" style={{ width: `${m.bond}%` }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* 中：日志 */}
                        <div className="flex-1 p-6 overflow-y-auto">
                            <div className="space-y-4">
                                {state.logs.map(log => (
                                    <div key={log.id} className="flex gap-4 animate-slide">
                                        <div className="w-1 bg-pink-400 rounded-full"></div>
                                        <div>
                                            <span className={`text-[10px] font-black uppercase ${log.color}`}>{log.tag}</span>
                                            <p className="text-gray-700 font-medium">{log.message}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 右：操作 */}
                        <div className="w-80 bg-gray-50 p-6 border-l flex flex-col gap-4">
                            <div className="bg-pink-600 text-white rounded-3xl p-6 text-center shadow-xl">
                                <div className="text-xs font-bold opacity-70 mb-1 tracking-widest uppercase">本季行动力</div>
                                <div className="text-5xl font-black">{state.actionsRemaining}</div>
                                {state.player.isKenmin && <div className="mt-2 text-[10px] bg-white/20 py-1 rounded-full">⚠️ 兼任中 (消耗1.5x)</div>}
                            </div>

                            <div className="space-y-2">
                                <button onClick={() => doAction('lesson')} disabled={state.actionsRemaining === 0} className="w-full p-4 bg-white border-2 border-transparent hover:border-pink-500 rounded-2xl flex items-center gap-4 transition-all group disabled:opacity-50">
                                    <div className="w-10 h-10 bg-pink-50 rounded-xl flex items-center justify-center text-pink-600 font-bold group-hover:bg-pink-600 group-hover:text-white">练</div>
                                    <div className="text-left"><div className="font-bold text-sm">课程训练</div><div className="text-[10px] text-gray-400">表现力 UP</div></div>
                                </button>
                                <button onClick={() => doAction('variety')} disabled={state.actionsRemaining === 0} className="w-full p-4 bg-white border-2 border-transparent hover:border-pink-500 rounded-2xl flex items-center gap-4 transition-all group disabled:opacity-50">
                                    <div className="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-600 font-bold group-hover:bg-orange-600 group-hover:text-white">综</div>
                                    <div className="text-left"><div className="font-bold text-sm">综艺录制</div><div className="text-[10px] text-gray-400">综艺 & 运营爱</div></div>
                                </button>
                                <button onClick={() => doAction('work')} disabled={state.actionsRemaining === 0} className="w-full p-4 bg-white border-2 border-transparent hover:border-pink-500 rounded-2xl flex items-center gap-4 transition-all group disabled:opacity-50">
                                    <div className="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 font-bold group-hover:bg-blue-600 group-hover:text-white">握</div>
                                    <div className="text-left"><div className="font-bold text-sm">握手会外务</div><div className="text-[10px] text-gray-400">人气 & 曝光</div></div>
                                </button>
                                <button onClick={() => doAction('bond')} disabled={state.actionsRemaining === 0} className="w-full p-4 bg-white border-2 border-transparent hover:border-pink-500 rounded-2xl flex items-center gap-4 transition-all group disabled:opacity-50">
                                    <div className="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center text-red-600 font-bold group-hover:bg-red-600 group-hover:text-white">私</div>
                                    <div className="text-left"><div className="font-bold text-sm">成员交流</div><div className="text-[10px] text-gray-400">建立 CP 关系</div></div>
                                </button>
                                <button onClick={() => doAction('rest')} disabled={state.actionsRemaining === 0} className="w-full p-4 bg-white border-2 border-transparent hover:border-pink-500 rounded-2xl flex items-center gap-4 transition-all group disabled:opacity-50">
                                    <div className="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center text-green-600 font-bold group-hover:bg-green-600 group-hover:text-white">休</div>
                                    <div className="text-left"><div className="font-bold text-sm">休息</div><div className="text-[10px] text-gray-400">恢复体力</div></div>
                                </button>
                            </div>

                            <button onClick={nextQuarter} disabled={state.actionsRemaining > 0 || isLoading} className="mt-auto w-full py-5 bg-black text-white rounded-3xl font-black text-xl shadow-2xl disabled:bg-gray-300">
                                {isLoading ? "结算中..." : "推进至下个季度"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // 初始化图标
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
